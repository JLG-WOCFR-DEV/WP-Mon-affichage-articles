# Revue du plugin « Mon Affichage Articles »

## Points forts
- L'essentiel de la logique serveur est centralisée dans `Mon_Affichage_Articles`, ce qui facilite le partage d'utilitaires comme le cache et la normalisation des options d'instance.【F:mon-affichage-article/mon-affichage-articles.php†L316-L420】【F:mon-affichage-article/mon-affichage-articles.php†L650-L706】
- Les contrôleurs REST délèguent la validation du nonce à une méthode dédiée et renvoient des erreurs WordPress standardisées, ce qui renforce la sécurité et la cohérence des réponses.【F:mon-affichage-article/includes/rest/class-my-articles-controller.php†L244-L317】

## Opportunités de refactoring
- `Mon_Affichage_Articles::prepare_filter_articles_response()` approche les 300 lignes et cumule de nombreuses responsabilités : validation des entrées, normalisation des options, construction des requêtes, rendu HTML, pagination et instrumentation.【F:mon-affichage-article/mon-affichage-articles.php†L316-L607】 Extraire des services dédiés (ex. `InstanceRequestValidator`, `ArticlesResponseBuilder`, `PaginationFormatter`) permettrait de réduire la complexité cyclomatique, de faciliter les tests unitaires ciblés et de rendre plus lisibles les futures évolutions.
- `prepare_filter_articles_response()` et `prepare_load_more_articles_response()` dupliquent une grande partie des étapes (normalisation d'options, vérification de catégorie autorisée, construction du cache).【F:mon-affichage-article/mon-affichage-articles.php†L316-L607】【F:mon-affichage-article/mon-affichage-articles.php†L650-L719】 En factorisant la logique commune (par exemple via une classe `InstanceQueryContext`), vous réduiriez le risque d'incohérences entre les deux flux et simplifieriez l'ajout de nouveaux paramètres.
- Le code JavaScript des modules `filter.js` et `load-more.js` répète quasiment à l'identique la gestion de l'instrumentation (lecture de la configuration, routage vers dataLayer/fetch/console) et le rafraîchissement du nonce REST.【F:mon-affichage-article/assets/js/filter.js†L5-L200】【F:mon-affichage-article/assets/js/load-more.js†L5-L200】 Extraire ces fonctions dans un utilitaire partagé (par exemple `assets/js/utils/instrumentation.js`) éviterait la dérive entre les implémentations et allégerait chaque module fonctionnel.

## Nettoyage de code et dépendances
- `Mon_Affichage_Articles::filter_articles_callback()` reste codé pour `admin-ajax`, mais aucun hook `wp_ajax_*` ne l'enregistre. La version REST semblant être la seule utilisée côté front (`getFilterEndpoint` pointe vers `/my-articles/v1/filter`), ce code est probablement mort et pourrait être supprimé avec le reste de la voie Ajax (y compris `sanitize_filters_parameter()` si elle n'est plus référencée ailleurs).【F:mon-affichage-article/mon-affichage-articles.php†L316-L648】【F:mon-affichage-article/assets/js/filter.js†L226-L284】
- Les deux modules front (`filter.js` / `load-more.js`) embarquent du code de debug (`DEBUG_STORAGE_KEY`, journalisation conditionnelle) mais aucune option ne semble exposée côté PHP pour activer/désactiver ce mode. Clarifier l'API (documentation, constantes) ou déplacer ces helpers dans un module de debug dédié simplifierait la lecture et éviterait de charger ce code en production si non utilisé.【F:mon-affichage-article/assets/js/load-more.js†L5-L110】
- Côté npm, `jquery` est déclaré en `devDependencies` pour les tests Jest qui s'en servent via `require('jquery')`. Il peut être utile de documenter cette contrainte dans `package.json` ou d'envisager un shim Jest plus léger si vous souhaitez alléger l'installation des dépendances, mais aucune suppression directe n'est recommandée tant que les tests l'utilisent.【F:mon-affichage-article/assets/js/__tests__/load-more.test.js†L26-L53】

## Recommandations
1. Planifier un refactoring progressif de `Mon_Affichage_Articles` en extrayant la construction des réponses et la préparation du contexte d'instance dans des classes dédiées. Commencez par couvrir ces blocs avec des tests pour sécuriser la scission.
2. Mutualiser les helpers JavaScript (instrumentation, nonce) dans un module commun, puis importer ces fonctions dans `filter.js` et `load-more.js` afin de diminuer la duplication et faciliter les évolutions.
3. Identifier et retirer les points d'entrée Ajax obsolètes (comme `filter_articles_callback`) pour ne conserver que le flux REST supporté officiellement. Pensez à supprimer les tests/unités associées et à mettre à jour la documentation.
